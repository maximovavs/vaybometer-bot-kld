#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
utils.py  â€¢ Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ¸ ĞºĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ñ‹ VayboMeter-Ğ±Ğ¾Ñ‚Ğ°.

Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚:
 - compass(deg)          â€” Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ²ĞµÑ‚Ñ€Ğ° Ğ¿Ğ¾ ÑƒĞ³Ğ»Ñƒ deg (0â€“360)
 - clouds_word(pc)       â€” Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Â«ÑÑĞ½Ğ¾/Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ/Ğ¿Ğ°ÑĞ¼ÑƒÑ€Ğ½Ğ¾Â» Ğ¿Ğ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ñƒ Ğ¾Ğ±Ğ»Ğ°Ñ‡Ğ½Ğ¾ÑÑ‚Ğ¸
 - wind_phrase(km_h)     â€” Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Â«ÑˆÑ‚Ğ¸Ğ»ÑŒ/ÑĞ»Ğ°Ğ±Ñ‹Ğ¹/ÑƒĞ¼ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹/ÑĞ¸Ğ»ÑŒĞ½Ñ‹Ğ¹Â» Ğ¿Ğ¾ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚Ğ¸ Ğ²ĞµÑ‚Ñ€Ğ°
 - safe(v, unit)         â€” None â†’ Â«â€”Â», Ñ‡Ğ¸ÑĞ»Ğ¾ â†’ Â«X.X{unit}Â»
 - aqi_color(aqi)        â€” ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ AQI
 - pm_color(pm, with_unit?) â€” ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ + Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ PMâ‚‚.â‚…/PMâ‚â‚€
 - kp_emoji(kp)          â€” ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ Ğ¿Ğ¾ Ğ¸Ğ½Ğ´ĞµĞºÑÑƒ Kp
 - pressure_trend(w)     â€” Ñ‚Ñ€ĞµĞ½Ğ´ Ğ´Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ (Â«â†‘Â», Â«â†“Â» Ğ¸Ğ»Ğ¸ Â«â†’Â»)
 - HTTP-Ğ¾Ğ±Ñ‘Ñ€Ñ‚ĞºĞ¸: _get / _get_retry
 - get_fact(date, region) â€” Â«Ñ„Ğ°ĞºÑ‚ Ğ´Ğ½ÑÂ» Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ñ€ĞµĞ³Ğ¸Ğ¾Ğ½Ğ°

ĞĞ¾Ğ²Ğ¾Ğµ:
 - kmh_to_ms(v)          â€” Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´ ĞºĞ¼/Ñ‡ â†’ Ğ¼/Ñ (Ñ Ğ¾ĞºÑ€ÑƒĞ³Ğ»ĞµĞ½Ğ¸ĞµĞ¼ Ğ´Ğ¾ 0.1)
 - ms_to_kmh(v)          â€” Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´ Ğ¼/Ñ â†’ ĞºĞ¼/Ñ‡
 - smoke_index(pm25, pm10) â€” Ğ¾Ñ†ĞµĞ½ĞºĞ° Â«Ğ·Ğ°Ğ´Ñ‹Ğ¼Ğ»ĞµĞ½Ğ¸ÑÂ» Ğ¿Ğ¾ PM (ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ + ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ)
"""

from __future__ import annotations
import time
import random
import requests
import pendulum
from typing import Any, Dict, Optional, List

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ĞšĞ¾Ğ¼Ğ¿Ğ°Ñ, Ğ¾Ğ±Ğ»Ğ°ĞºĞ°, Ğ²ĞµÑ‚ĞµÑ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

COMPASS = [
    "Ğ¡",   # Ğ¡ĞµĞ²ĞµÑ€
    "Ğ¡Ğ¡Ğ’", # Ğ¡ĞµĞ²ĞµÑ€Ğ¾-ÑĞµĞ²ĞµÑ€Ğ¾-Ğ²Ğ¾ÑÑ‚Ğ¾Ğº
    "Ğ¡Ğ’",  # Ğ¡ĞµĞ²ĞµÑ€Ğ¾-Ğ²Ğ¾ÑÑ‚Ğ¾Ğº
    "Ğ’Ğ¡Ğ’", # Ğ’Ğ¾ÑÑ‚Ğ¾Ğº-ÑĞµĞ²ĞµÑ€Ğ¾-Ğ²Ğ¾ÑÑ‚Ğ¾Ğº
    "Ğ’",   # Ğ’Ğ¾ÑÑ‚Ğ¾Ğº
    "Ğ’Ğ®Ğ’", # Ğ’Ğ¾ÑÑ‚Ğ¾Ğº-ÑĞ³Ğ¾-Ğ²Ğ¾ÑÑ‚Ğ¾Ğº
    "Ğ®Ğ’",  # Ğ®Ğ³Ğ¾-Ğ²Ğ¾ÑÑ‚Ğ¾Ğº
    "Ğ®Ğ®Ğ’", # Ğ®Ğ³Ğ¾-ÑĞ³Ğ¾-Ğ²Ğ¾ÑÑ‚Ğ¾Ğº
    "Ğ®",   # Ğ®Ğ³
    "Ğ®Ğ®Ğ—", # Ğ®Ğ³Ğ¾-ÑĞ³Ğ¾-Ğ·Ğ°Ğ¿Ğ°Ğ´
    "Ğ®Ğ—",  # Ğ®Ğ³Ğ¾-Ğ·Ğ°Ğ¿Ğ°Ğ´
    "Ğ—Ğ®Ğ—", # Ğ—Ğ°Ğ¿Ğ°Ğ´-ÑĞ³Ğ¾-Ğ·Ğ°Ğ¿Ğ°Ğ´
    "Ğ—",   # Ğ—Ğ°Ğ¿Ğ°Ğ´
    "Ğ—Ğ¡Ğ—", # Ğ—Ğ°Ğ¿Ğ°Ğ´-ÑĞµĞ²ĞµÑ€Ğ¾-Ğ·Ğ°Ğ¿Ğ°Ğ´
    "Ğ¡Ğ—",  # Ğ¡ĞµĞ²ĞµÑ€Ğ¾-Ğ·Ğ°Ğ¿Ğ°Ğ´
    "Ğ¡Ğ¡Ğ—", # Ğ¡ĞµĞ²ĞµÑ€Ğ¾-ÑĞµĞ²ĞµÑ€Ğ¾-Ğ·Ğ°Ğ¿Ğ°Ğ´
]

def compass(deg: float) -> str:
    """
    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñƒ ÑĞ²ĞµÑ‚Ğ° (Ğ¸Ğ· 16) Ğ¿Ğ¾ ÑƒĞ³Ğ»Ñƒ deg (0â€“360).
    """
    index = int((deg / 22.5) + 0.5) % 16
    return COMPASS[index]

def clouds_word(pc: int) -> str:
    """
    ĞŸĞ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ñƒ Ğ¾Ğ±Ğ»Ğ°Ñ‡Ğ½Ğ¾ÑÑ‚Ğ¸:
      <25% â†’ Â«ÑÑĞ½Ğ¾Â»
      <70% â†’ Â«Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°ÑÂ»
      Ğ¸Ğ½Ğ°Ñ‡Ğµ â†’ Â«Ğ¿Ğ°ÑĞ¼ÑƒÑ€Ğ½Ğ¾Â»
    """
    if pc < 25:
        return "ÑÑĞ½Ğ¾"
    if pc < 70:
        return "Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ"
    return "Ğ¿Ğ°ÑĞ¼ÑƒÑ€Ğ½Ğ¾"

def wind_phrase(km_h: float) -> str:
    """
    ĞŸĞ¾ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚Ğ¸ Ğ²ĞµÑ‚Ñ€Ğ° (ĞºĞ¼/Ñ‡):
      < 2  â†’ Â«ÑˆÑ‚Ğ¸Ğ»ÑŒÂ»
      < 8  â†’ Â«ÑĞ»Ğ°Ğ±Ñ‹Ğ¹Â»
      < 14 â†’ Â«ÑƒĞ¼ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹Â»
      Ğ¸Ğ½Ğ°Ñ‡Ğµ â†’ Â«ÑĞ¸Ğ»ÑŒĞ½Ñ‹Ğ¹Â»
    """
    if km_h < 2:
        return "ÑˆÑ‚Ğ¸Ğ»ÑŒ"
    if km_h < 8:
        return "ÑĞ»Ğ°Ğ±Ñ‹Ğ¹"
    if km_h < 14:
        return "ÑƒĞ¼ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹"
    return "ÑĞ¸Ğ»ÑŒĞ½Ñ‹Ğ¹"

def kmh_to_ms(v_kmh: Optional[float]) -> Optional[float]:
    """
    ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ¸Ñ‚ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ Ğ¸Ğ· ĞºĞ¼/Ñ‡ Ğ² Ğ¼/Ñ Ñ Ğ¾ĞºÑ€ÑƒĞ³Ğ»ĞµĞ½Ğ¸ĞµĞ¼ Ğ´Ğ¾ 0.1.
    None â†’ None.
    """
    if v_kmh is None:
        return None
    try:
        return round(float(v_kmh) / 3.6, 1)
    except (TypeError, ValueError):
        return None

def ms_to_kmh(v_ms: Optional[float]) -> Optional[float]:
    """
    ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ¸Ñ‚ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ Ğ¸Ğ· Ğ¼/Ñ Ğ² ĞºĞ¼/Ñ‡ Ñ Ğ¾ĞºÑ€ÑƒĞ³Ğ»ĞµĞ½Ğ¸ĞµĞ¼ Ğ´Ğ¾ 0.1.
    None â†’ None.
    """
    if v_ms is None:
        return None
    try:
        return round(float(v_ms) * 3.6, 1)
    except (TypeError, ValueError):
        return None

def safe(v: Any, unit: str = "") -> str:
    """
    None / 'None' / 'â€”' â†’ Â«â€”Â»
    Ğ§Ğ¸ÑĞ»Ğ¾ â†’ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ° Ñ ĞµĞ´Ğ¸Ğ½Ğ¸Ñ†ĞµĞ¹.
    """
    if v in (None, "None", "â€”"):
        return "â€”"
    if isinstance(v, (int, float)):
        return f"{v:.1f}{unit}"
    return f"{v}{unit}"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ AQI & PM Ñ€Ğ°ÑĞºÑ€Ğ°ÑĞºĞ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def aqi_color(aqi: int | float | str) -> str:
    """
    Ğ­Ğ¼Ğ¾Ğ´Ğ·Ğ¸ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ AQI:
      â‰¤ 50   â†’ ğŸŸ¢
      â‰¤100   â†’ ğŸŸ¡
      â‰¤150   â†’ ğŸŸ 
      â‰¤200   â†’ ğŸ”´
      â‰¤300   â†’ ğŸŸ£
      >300   â†’ ğŸŸ¤
      Â«â€”Â»/Â«Ğ½/Ğ´Â» â†’ âšª
    """
    if aqi in ("â€”", "Ğ½/Ğ´"):
        return "âšª"
    try:
        val = float(aqi)
    except (TypeError, ValueError):
        return "âšª"
    if val <= 50:
        return "ğŸŸ¢"
    if val <= 100:
        return "ğŸŸ¡"
    if val <= 150:
        return "ğŸŸ "
    if val <= 200:
        return "ğŸ”´"
    if val <= 300:
        return "ğŸŸ£"
    return "ğŸŸ¤"

def pm_color(pm: Optional[float | int | str], with_unit: bool = False) -> str:
    """
    Ğ¦Ğ²ĞµÑ‚Ğ¾Ğ²Ğ°Ñ Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ½Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ PMâ‚‚.â‚… / PMâ‚â‚€:
      â‰¤ 12   â†’ ğŸŸ¢
      â‰¤ 35   â†’ ğŸŸ¡
      â‰¤ 55   â†’ ğŸŸ 
      â‰¤150   â†’ ğŸ”´
      â‰¤250   â†’ ğŸŸ£
      >250   â†’ ğŸŸ¤
      None / Â«â€”Â»/Â«Ğ½/Ğ´Â» â†’ âšª Ğ½/Ğ´
    """
    if pm in (None, "â€”", "Ğ½/Ğ´"):
        return "âšª Ğ½/Ğ´"
    try:
        val = float(pm)
    except (TypeError, ValueError):
        return "âšª Ğ½/Ğ´"
    if val <= 12:
        emoji = "ğŸŸ¢"
    elif val <= 35:
        emoji = "ğŸŸ¡"
    elif val <= 55:
        emoji = "ğŸŸ "
    elif val <= 150:
        emoji = "ğŸ”´"
    elif val <= 250:
        emoji = "ğŸŸ£"
    else:
        emoji = "ğŸŸ¤"
    txt = str(int(round(val)))
    if with_unit:
        txt += " Âµg/Ğ¼Â³"
    return f"{emoji}{txt}"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ˜Ğ½Ğ´ĞµĞºÑ Â«Ğ·Ğ°Ğ´Ñ‹Ğ¼Ğ»ĞµĞ½Ğ¸ÑÂ» Ğ¿Ğ¾ PM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def smoke_index(pm25: Optional[float | int | str],
                pm10:  Optional[float | int | str]) -> tuple[str, str]:
    """
    ĞÑ†ĞµĞ½ĞºĞ° Â«Ğ·Ğ°Ğ´Ñ‹Ğ¼Ğ»ĞµĞ½Ğ¸ÑÂ» Ğ¿Ğ¾ PM:
      Ğ‘Ğ°Ğ·Ğ° â€” Ğ¿Ğ¾ PM2.5 (Âµg/mÂ³):
        0â€“25  â†’ Ğ½Ğ¸Ğ·ĞºĞ¾Ğµ
        25â€“55 â†’ ÑÑ€ĞµĞ´Ğ½ĞµĞµ
        >55   â†’ Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ğµ
      ĞœĞ¾Ğ´Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ÑÑ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¼ĞµÑ‚Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ½Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸:
        ĞµÑĞ»Ğ¸ PM2.5 â‰¥ 20 Ğ¸ PM10 > 0 Ğ¸ (PM2.5/PM10) > 0.70 â†’ +1 ÑÑ‚ÑƒĞ¿ĞµĞ½ÑŒ (Ğ´Ğ¾ Â«Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ğ³Ğ¾Â»).
    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ (emoji, label). ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… â†’ (âšª, "Ğ½/Ğ´").
    """
    def _to_float(x):
        try:
            return float(x)
        except (TypeError, ValueError):
            return None

    p25 = _to_float(pm25)
    p10 = _to_float(pm10)
    if p25 is None:
        return "âšª", "Ğ½/Ğ´"

    if p25 <= 25:
        lvl = 0  # Ğ½Ğ¸Ğ·ĞºĞ¾Ğµ
    elif p25 <= 55:
        lvl = 1  # ÑÑ€ĞµĞ´Ğ½ĞµĞµ
    else:
        lvl = 2  # Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ğµ

    if p25 >= 20 and p10 and p10 > 0:
        ratio = p25 / p10
        if ratio > 0.70:
            lvl = min(lvl + 1, 2)

    if lvl == 0:
        return "ğŸŸ¢", "Ğ½Ğ¸Ğ·ĞºĞ¾Ğµ"
    if lvl == 1:
        return "ğŸŸ¡", "ÑÑ€ĞµĞ´Ğ½ĞµĞµ"
    return "ğŸ”´", "Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ğµ"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Â«Ğ¤Ğ°ĞºÑ‚ Ğ´Ğ½ÑÂ» Ğ¿Ğ¾ Ñ€ĞµĞ³Ğ¸Ğ¾Ğ½Ñƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

FACTS_KLGD: Dict[str, str] = {
    # â€¦ (Ğ²ÑĞµ Ñ‚Ğ²Ğ¾Ğ¸ Ñ„Ğ°ĞºÑ‚Ñ‹; Ğ½Ğµ ÑƒÑ€ĞµĞ·Ğ°Ğ»)
    "01-01": "1 ÑĞ½Ğ²Ğ°Ñ€Ñ â€” ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ³Ğ¾Ğ´: ĞšĞ°Ğ»Ğ¸Ğ½Ğ¸Ğ½Ğ³Ñ€Ğ°Ğ´ ÑĞ¸ÑĞµÑ‚ Ğ³Ğ¸Ñ€Ğ»ÑĞ½Ğ´Ğ°Ğ¼Ğ¸, Ğ° Ğ½Ğ° Ğ‘Ğ°Ğ»Ñ‚Ğ¸ĞºĞµ Ğ¿ÑŒÑÑ‚ Ğ³Ğ»Ğ¸Ğ½Ñ‚Ğ²ĞµĞ¹Ğ½ ğŸ†ğŸ·",
    # (Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ±Ğ»Ğ¾Ğº Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹)
    "12-31": "31 Ğ´ĞµĞºĞ°Ğ±Ñ€Ñ â€” ĞšĞ°Ğ½ÑƒĞ½ ĞĞ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ³Ğ¾Ğ´Ğ°: ĞšĞ°Ğ»Ğ¸Ğ½Ğ¸Ğ½Ğ³Ñ€Ğ°Ğ´ ÑĞ¸ÑĞµÑ‚, Ğ° Ğ½Ğ° ĞºĞ¾ÑĞµ Ğ¿ÑŒÑÑ‚ ÑˆĞ°Ğ¼Ğ¿Ğ°Ğ½ÑĞºĞ¾Ğµ ğŸ¥‚",
}

FACTS_KLGD_RANDOM: List[str] = [
    "ĞšĞ°Ğ»Ğ¸Ğ½Ğ¸Ğ½Ğ³Ñ€Ğ°Ğ´ â€” ĞµĞ´Ğ¸Ğ½ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ³Ğ¸Ğ¾Ğ½ Ğ Ğ¾ÑÑĞ¸Ğ¸ Ğ±ĞµĞ· ÑÑƒÑ…Ğ¾Ğ¿ÑƒÑ‚Ğ½Ğ¾Ğ¹ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ñ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¾Ğ¹ ğŸ—ºï¸",
    # â€¦ (Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹)
    "ĞšĞ°Ğ»Ğ¸Ğ½Ğ¸Ğ½Ğ³Ñ€Ğ°Ğ´ÑĞºĞ¸Ğ¹ Ğ¼Ğ¾ÑÑ‚ ĞšĞ¾Ñ€Ğ¾Ğ»ĞµĞ²Ñ‹ Ğ›ÑƒĞ¸Ğ·Ñ‹ ÑĞ¾ĞµĞ´Ğ¸Ğ½ÑĞµÑ‚ Ğ Ğ¾ÑÑĞ¸Ñ Ğ¸ Ğ›Ğ¸Ñ‚Ğ²Ñƒ ğŸŒ‰",
]

FACTS_CY: Dict[str, str] = {
    "01-03": "3 ÑĞ½Ğ²Ğ°Ñ€Ñ â€” Ğ¤ĞµÑÑ‚Ğ¸Ğ²Ğ°Ğ»ÑŒ Ğ³Ñ€Ğ°Ğ½Ğ°Ñ‚Ğ¾Ğ² Ğ² ĞÑ€Ğ¼Ğ¸Ğ´Ğ¸Ğ¸: Ğ´ĞµĞ³ÑƒÑÑ‚Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ Ñ‚Ğ°Ğ½Ñ†Ñ‹ Ğ¿Ğ¾Ğ´ Ğ·Ğ²ĞµĞ·Ğ´Ğ°Ğ¼Ğ¸, Ğ° Ğ² 1960 Ğ³Ğ¾Ğ´Ñƒ ĞšĞ¸Ğ¿Ñ€ ÑÑ‚Ğ°Ğ» Ñ€ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ¾Ğ¹ ğŸ",
    # â€¦ (ĞºĞ°Ğº Ğ±Ñ‹Ğ»Ğ¾)
}

DEFAULT_FACTS_CY: List[str] = [
    "ĞĞ° ĞšĞ¸Ğ¿Ñ€Ğµ Ğ±Ğ¾Ğ»ĞµĞµ 1 800 Ğ²Ğ¸Ğ´Ğ¾Ğ² Ñ€Ğ°ÑÑ‚ĞµĞ½Ğ¸Ğ¹ â€” Ğ²ĞµÑĞ½Ğ° Ñ‚ÑƒÑ‚ Ñ†Ğ²ĞµÑ‚Ñ‘Ñ‚ ÑÑ€Ñ‡Ğµ Ğ»ÑĞ±Ğ¾Ğ³Ğ¾ Instagram-Ğ¿Ğ¾ÑÑ‚Ğ° ğŸŒ¸",
    # â€¦
]

DEFAULT_FACTS_UNI: List[str] = [
    "Ğ›ÑƒĞ½Ğ° ÑƒĞ´Ğ°Ğ»ÑĞµÑ‚ÑÑ Ğ¾Ñ‚ Ğ—ĞµĞ¼Ğ»Ğ¸ Ğ½Ğ° 3.8 ÑĞ¼ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ³Ğ¾Ğ´.",
    "Ğ§ĞµĞ»Ğ¾Ğ²ĞµÑ‡ĞµÑĞºĞ¸Ğ¹ Ğ¼Ğ¾Ğ·Ğ³ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ ÑĞ½ĞµÑ€Ğ³Ğ¸Ğ¸, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾ÑĞ²ĞµÑ‚Ğ¸Ñ‚ÑŒ Ğ»Ğ°Ğ¼Ğ¿Ğ¾Ñ‡ĞºÑƒ.",
    "Ğ’ ĞºĞ¾ÑĞ¼Ğ¾ÑĞµ Ğ·Ğ²ÑƒĞºĞ¸ Ğ½Ğµ Ñ€Ğ°ÑĞ¿Ñ€Ğ¾ÑÑ‚Ñ€Ğ°Ğ½ÑÑÑ‚ÑÑ, Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼Ñƒ Ñ‡Ñ‚Ğ¾ Ñ‚Ğ°Ğ¼ Ğ½ĞµÑ‚ Ğ°Ñ‚Ğ¼Ğ¾ÑÑ„ĞµÑ€Ñ‹.",
    "Ğ¡Ğ¾Ğ»Ğ½Ñ†Ğµ ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ 99.86 % Ğ¼Ğ°ÑÑÑ‹ Ğ¡Ğ¾Ğ»Ğ½ĞµÑ‡Ğ½Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹.",
    "ĞœĞ¾Ğ»Ğ½Ğ¸Ñ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ³Ğ¾Ñ€ÑÑ‡ĞµĞµ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¡Ğ¾Ğ»Ğ½Ñ†Ğ° (Ğ´Ğ¾ 30 000 Â°C).",
    "ĞŸĞ»Ğ°Ğ½ĞµÑ‚Ğ° Ğ’ĞµĞ½ĞµÑ€Ğ° Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ Ğ² Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾Ğ¼ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ (Ñ€ĞµÑ‚Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ´Ğ½Ğ¾).",
]

def get_fact(date: pendulum.Date, region: str = "") -> str:
    r = region.lower()
    if "ĞºĞ°Ğ»Ğ¸Ğ½Ğ¸Ğ½Ğ³Ñ€Ğ°Ğ´" in r:
        key = date.format("MM-DD")
        return FACTS_KLGD.get(key, random.choice(FACTS_KLGD_RANDOM))
    if "ĞºĞ¸Ğ¿Ñ€" in r:
        key = date.format("MM-DD")
        return FACTS_CY.get(key, random.choice(DEFAULT_FACTS_CY))
    idx = date.day % len(DEFAULT_FACTS_UNI)
    return DEFAULT_FACTS_UNI[idx]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ Ğ¸ĞºĞ¾Ğ½ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

WEATHER_ICONS: Dict[str, str] = {
    "ÑÑĞ½Ğ¾":      "â˜€ï¸",
    "Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ": "ğŸŒ§ï¸",
    "Ğ¿Ğ°ÑĞ¼ÑƒÑ€Ğ½Ğ¾":  "â˜ï¸",
    "Ğ´Ğ¾Ğ¶Ğ´ÑŒ":     "ğŸŒ§ï¸",
    "Ñ‚ÑƒĞ¼Ğ°Ğ½":     "ğŸŒ«ï¸",
}

AIR_EMOJI: Dict[str, str] = {
    "Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¸Ğ¹":    "ğŸŸ¢",
    "ÑƒĞ¼ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹":  "ğŸŸ¡",
    "Ğ²Ñ€ĞµĞ´Ğ½Ñ‹Ğ¹":    "ğŸŸ ",
    "Ğ¾Ñ‡. Ğ²Ñ€ĞµĞ´Ğ½Ñ‹Ğ¹": "ğŸ”´",
    "Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğ¹":    "ğŸŸ£",
    "Ğ½/Ğ´":        "âšª",
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ kp_emoji â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def kp_emoji(kp: Optional[float]) -> str:
    if kp is None:
        return "âšª"
    k = int(round(kp))
    if k < 3:
        return "âšª"
    if k < 5:
        return "ğŸŸ¢"
    return "ğŸ”´"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ¢Ñ€ĞµĞ½Ğ´ Ğ´Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def pressure_trend(w: Dict[str, Any]) -> str:
    """
    â†‘ ĞµÑĞ»Ğ¸ Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞ¸Ğ¹ Ñ‡Ğ°Ñ > +2 Ğ³ĞŸĞ°, â†“ ĞµÑĞ»Ğ¸ < âˆ’2, Ğ¸Ğ½Ğ°Ñ‡Ğµ â†’.
    w â€” Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ hourly.surface_pressure (ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ‡Ğ¸ÑĞµĞ»).
    """
    hp = w.get("hourly", {}).get("surface_pressure", [])
    if len(hp) < 2:
        return "â†’"
    diff = hp[-1] - hp[0]
    if diff >= 2:
        return "â†‘"
    if diff <= -2:
        return "â†“"
    return "â†’"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ HTTP-Ğ¾Ğ±Ñ‘Ñ€Ñ‚ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

_HEADERS = {
    "User-Agent": "VayboMeter/1.0 (+https://github.com/)",
    "Accept":     "application/json",
}

def _get_retry(url: str, retries: int = 2, **params) -> Optional[dict]:
    attempt = 0
    while attempt <= retries:
        try:
            r = requests.get(url, params=params, timeout=15, headers=_HEADERS)
            r.raise_for_status()
            return r.json()
        except Exception:
            attempt += 1
            if attempt > retries:
                return None
            time.sleep(0.5 * attempt)

def _get(url: str, **params) -> Optional[dict]:
    return _get_retry(url, retries=2, **params)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Module self-test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if __name__ == "__main__":
    import sys
    print("kmh_to_ms demo:", kmh_to_ms(18), kmh_to_ms(None))
    print("ms_to_kmh demo:", ms_to_kmh(5), ms_to_kmh(None))
    print("Smoke index demo:", smoke_index(12, 30), smoke_index(40, 50), smoke_index(80, 90), smoke_index(None, 10))
    sys.exit(0)
